# Matburk

## âš ï¸ IMPORTANT âš ï¸

âš ï¸ **NOTE:** This project is currently about 99.9% AI-generated by Google Gemini, except for this "Important" chapter.
I just wanted a simple weekly meal prep planner, and this is the result.

# Home Meal Planner

A full-stack web application for weekly meal planning, specifically designed for households managing lunch boxes ("matlÃ¥dor") and individual planning slots for two people (Person A and Person B).

## ğŸ§  Context for AI Agents & LLMs

**Project Goal:** Simplify weekly food planning by syncing a library of recipes with a weekly calendar grid.

**Core Logic & "Gotchas":**

- **The Grid:** 7 Days Ã— 2 Meals (Lunch/Dinner) Ã— 2 People.
- **The "Batch" (MatlÃ¥da) System:**
  - The UI calculates "active batches" based on the weekly plan.
  - **Race Condition Fix:** When deleting a batch, the frontend uses a local "ignore list" (`removedRecipeIds` state) to prevent the batch from reappearing (zombie state) while the server processes the deletion asynchronously.
- **Placeholders:**
  - Entries like "Takeaway" or "Leftovers" are treated as recipes but flagged as `is_placeholder = True`.
  - **Sorting Logic:** Frontend forces placeholders to the top of the library (sorted by ID) regardless of the user's selected sort order. They have distinct styling (Amber color) in the grid.
- **Settings (Person A/B):**
  - The database uses fixed keys `"A"` and `"B"` for logic stability.
  - Display names are dynamic and stored in a `settings` table. The frontend maps these keys to names like "Anna" or "Erik".
- **Search & Sort:**
  - Backend handles main sorting (Vote count, Date, Name). Name sorting is case-insensitive (`func.lower()`).
  - Frontend handles the separation of "Placeholders" vs "Standard Recipes".

---

## ğŸ›  Tech Stack

### Backend

- **Language:** Python 3.x
- **Framework:** FastAPI
- **Database:** SQLite (local file: `matplanerare.db`)
- **ORM:** SQLAlchemy
- **Image Handling:** Stores uploads locally in `backend/uploads` (served at `/images`).

### Frontend

- **Framework:** React (Vite)
- **Styling:** Tailwind CSS
- **HTTP Client:** Axios
- **Date Handling:** date-fns
- **Icons:** Lucide React & raw SVGs

---

## ğŸ“‚ Project Structure

```text
root/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ main.py           # API Endpoints, Static mounts, Startup/Seed logic
â”‚   â”œâ”€â”€ models.py         # SQLAlchemy Database Models
â”‚   â”œâ”€â”€ schemas.py        # Pydantic Response/Request Models
â”‚   â”œâ”€â”€ database.py       # DB Connection setup
â”‚   â””â”€â”€ uploads/          # User uploaded images (mounted at /images)
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ PlannerGrid.jsx    # MAIN LOGIC: Calendar, Library, State management
â”‚   â”‚   â”‚   â”œâ”€â”€ AddRecipe.jsx      # Form to create recipes
â”‚   â”‚   â”‚   â”œâ”€â”€ EditRecipe.jsx     # Form to edit/delete recipes
â”‚   â”‚   â”‚   â”œâ”€â”€ RecipeDetails.jsx  # Read-only modal with full info
â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsModal.jsx  # Modal to rename Person A/B
â”‚   â”‚   â”‚   â””â”€â”€ TagInput.jsx       # UX component for comma-separated tags
â”‚   â”‚   â”œâ”€â”€ App.jsx                # Layout, State lifting (Date/Sort/Settings)
â”‚   â”‚   â””â”€â”€ main.jsx
â”‚   â””â”€â”€ tailwind.config.js
â””â”€â”€ README.md
```

---

## ğŸ—„ï¸ Data Models (Schema)

### 1. Recipes (`recipes` table)

| Field              | Type     | Description                                    |
| ------------------ | -------- | ---------------------------------------------- |
| `id`               | Integer  | Primary Key                                    |
| `name`             | String   | Recipe title                                   |
| `default_portions` | Integer  | Default: 4                                     |
| `notes`            | String   | User notes/reminders                           |
| `link`             | String   | External link to recipe source                 |
| `image_filename`   | String   | Local filename (Priority 1)                    |
| `image_url`        | String   | External URL (Priority 2)                      |
| `is_placeholder`   | Boolean  | If True: Special handling for "Takeaway", etc. |
| `is_test_recipe`   | Boolean  | Seed/test fixture flag                         |
| `is_deleted`       | Boolean  | Soft delete flag                               |
| `last_cooked_date` | Date     | Auto-updated when planned                      |
| `vote_count`       | Integer  | "Likes"                                        |
| `created_at`       | DateTime | Insert timestamp                               |
| `updated_at`       | DateTime | Update timestamp                               |

Tags are stored in a separate `tags` table with a many-to-many `recipe_tags` join. API responses return tag objects.

### 2. Planning Slots (`plan_slots` table)

Stores exactly what is planned for a specific coordinate.
| Field | Type | Description |
|-------|------|-------------|
| `id` | Integer | PK |
| `plan_date` | Date | YYYY-MM-DD |
| `meal_type` | String | "Lunch" or "Middag" |
| `person` | String | "A" or "B" (Fixed keys) |
| `recipe_id` | Integer | FK to Recipe |

### 3. Settings (`settings` table)

Key-Value store for global app configuration.
| Key | Value |
|-----|-------|
| `name_A` | e.g., "Mamma" |
| `name_B` | e.g., "Pappa" |

---

## ğŸš€ Features & UX Logic

### Library View

- **View Modes:** Minimal, Compact, Detailed (toggleable in UI).
- **Tag Filter:** Optional filter panel to narrow by tags.
- **Quick Add:** Placeholder "Snabbval" recipes surface first for fast planning.

- **Image Fallback Strategy:**

1. Check for `image_filename` (Uploaded).
2. Check for `image_url` (External link).
3. Render default placeholder (Gray div with ğŸ½ï¸ icon).

### Calendar Grid

- **Visual Feedback:** Uses `ring-inset` CSS to highlight active slots without altering element size (preventing layout shift).
- **Text Handling:** Uses `break-words` and `min-w-0` flex properties to allow text to wrap vertically instead of overflowing horizontally.

### CRUD & State

- **Tags:** Managed via a `TagInput` component; stored as tag rows (not CSV) and returned as tag objects.
- **Soft Delete:** Deleting a recipe sets `is_deleted = True`. It remains in the DB but is filtered out of the API response.
- **Week Lock:** Weeks can be locked/unlocked in the UI to prevent accidental edits.

---

## âš¡ï¸ API Endpoints

- `GET /recipes` params: `sort_by` (`vote`, `name`, `last_cooked`, `total_meals`, `created`), `sort_order` (`asc`/`desc`)
- `POST /recipes` (multipart form; optional file upload)
- `PUT /recipes/{id}` (multipart form; optional file upload)
- `PUT /recipes/{id}/vote` (increment vote_count)
- `DELETE /recipes/{id}` (soft delete)
- `GET /plan` params: `start_date`, `end_date`
- `POST /plan` (upsert a slot)
- `GET /settings`
- `POST /settings`

---

## ğŸƒâ€â™‚ï¸ How to Run

### Backend

1. Navigate to `backend/`.
2. Create virtual env: `python -m venv venv`
3. Activate: `source venv/bin/activate` (Mac/Linux) or `venv\Scripts\activate` (Win)
4. Install deps: `pip install -r requirements.txt`
5. Run: `./run.sh` (prefers local venv and starts `uvicorn main:app --reload`)

### Frontend

1. Navigate to `frontend/`.
2. Install deps: `npm install`
3. Run: `npm run dev -- --host`

From repository root you can also run `npm run dev` to start the frontend with the configured prefix script.

---

_Generated for AI context maintenance._
